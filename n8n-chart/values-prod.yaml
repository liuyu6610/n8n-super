# 生产环境 Helm Values（n8n-chart）
# 目标：queue 模式（main+worker+webhook）、使用 n8n-super 镜像、内置 Redis+PostgreSQL、并强制所有密钥/密码统一使用同一个 existingSecret
# 兼容：Kubernetes 1.20+ / n8n 1.78.x（按需调整）

image:
  repository: crpi-n5rumpjwbqinoz4c.cn-hangzhou.personal.cr.aliyuncs.com/n8nioliuyu/n8n
  tag: "super-1.78.1"
  pullPolicy: IfNotPresent

imagePullSecrets: []

timezone: "Asia/Shanghai"

log:
  level: info
  output:
    - console

# 强制使用同一个 Secret（必须预先创建）
# 该 Secret 需要至少包含如下 key：
# - N8N_ENCRYPTION_KEY: n8n 加密密钥（必须固定，否则重装后会因密钥不匹配导致凭据解密失败/启动报错）
# - postgres-password: PostgreSQL 密码（若使用 postgres 用户）
# - redis-password: Redis 密码
existingEncryptionKeySecret: "n8n-one-secret"

# n8n 数据库：使用 Postgres（生产推荐）
db:
  type: postgresdb
  postgresdb:
    poolSize: 10
    connectionTimeout: 20000
    idleConnectionTimeout: 30000
    schema: public
    ssl:
      enabled: false

# 关闭遥测/版本提示（离线/内网更稳）
diagnostics:
  enabled: false

versionNotifications:
  enabled: false

# 关闭 Public API（减少暴露面，如需再开）
api:
  enabled: false
  path: api
  swagger:
    enabled: false

# 禁止运行时安装社区节点/外部 npm（内网环境避免联网依赖）
nodes:
  builtin:
    enabled: false
    modules: []
  external:
    allowAll: false
    reinstallMissingPackages: false
    packages: []

npmRegistry:
  enabled: false
  url: ""
  secretName: ""
  secretKey: "npmrc"
  customNpmrc: ""

# main/worker/webhook 分离（queue 模式）
main:
  count: 1
  # 注意：如开启 ingress 并有域名，请同步设置 editorBaseUrl / N8N_HOST / N8N_PROTOCOL
  editorBaseUrl: "http://n8n-it.saturn-res.ipa.zs"

  extraEnvVars:
    TZ: "Asia/Shanghai"
    GENERIC_TIMEZONE: "Asia/Shanghai"
    N8N_TRUST_PROXY: "true"
    N8N_PROTOCOL: "http"
    N8N_HOST: "n8n-it.saturn-res.ipa.zs"
    N8N_PUSH_BACKEND: "websocket"
    # 明确 queue（虽然 chart 会在 queue-configmap 里写，但显式写更直观）
    EXECUTIONS_MODE: "queue"

  # n8n 主数据目录（工作流/凭据/配置等）
  # 为了测试使用 kubectl apply rendered.yaml，这里改为由 chart 创建 PVC，并显式指定 storageClass
  persistence:
    enabled: true
    mountPath: "/home/node/.n8n"
    storageClass: "it"
    size: 10Gi
    accessMode: ReadWriteOnce

  resources:
    requests:
      cpu: "500m"
      memory: 1Gi
    limits:
      cpu: "2"
      memory: 4Gi

worker:
  mode: queue
  count: 1
  # worker 一般不需要持久化；如你的任务需要本地文件缓存/二进制落盘，可单独开启 worker.persistence
  extraEnvVars:
    TZ: "Asia/Shanghai"
    GENERIC_TIMEZONE: "Asia/Shanghai"

  persistence:
    enabled: false

  resources:
    requests:
      cpu: "500m"
      memory: 1Gi
    limits:
      cpu: "2"
      memory: 4Gi

webhook:
  mode: queue
  count: 1
  # webhook.url 用于生成回调 URL（建议与你的外部访问地址一致）
  url: "http://n8n-it.saturn-res.ipa.zs/"

  extraEnvVars:
    TZ: "Asia/Shanghai"
    GENERIC_TIMEZONE: "Asia/Shanghai"

  resources:
    requests:
      cpu: "200m"
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 2Gi

# Ingress（按需开启）
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
  hosts:
    - host: n8n-it.saturn-res.ipa.zs
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Redis（队列必需）
# 这里既启用 chart 内置 Redis，又让 n8n 读取 externalRedis.existingSecret（统一密钥来源）
redis:
  enabled: true
  architecture: standalone
  global:
    imageRegistry: "nexus2.ipa.zs:5000"
    security:
      allowInsecureImages: true
  image:
    registry: "nexus2.ipa.zs:5000"
    repository: bitnamilegacy/redis
    tag: latest
  auth:
    enabled: true
    existingSecret: "n8n-one-secret"

  master:
    persistence:
      enabled: true
      storageClass: "it"
      size: 4Gi

# n8n 应用侧读取 Redis 认证信息（统一 secret）
externalRedis:
  existingSecret: "n8n-one-secret"
  # 与 Redis 子 chart 保持一致的逻辑库（Bull queue）
  database: 0
  # host/port 在 redis.enabled=true 时会自动使用 release-redis-master
  host: ""
  port: 6379

# PostgreSQL（生产必需）
postgresql:
  enabled: true
  architecture: standalone
  global:
    imageRegistry: "nexus2.ipa.zs:5000"
    security:
      allowInsecureImages: true
  image:
    registry: "nexus2.ipa.zs:5000"
    repository: bitnamilegacy/postgresql
    tag: latest
  auth:
    # 使用 postgres 管理用户（username 为空会走 postgres-password key）
    username: ""
    database: "n8n"
    existingSecret: "n8n-one-secret"

  primary:
    persistence:
      enabled: true
      storageClass: "it"
      size: 20Gi

# n8n 应用侧读取 Postgres 密码（统一 secret）
externalPostgresql:
  existingSecret: "n8n-one-secret"
  host: ""
  port: 5432
  database: "n8n"

# 监控按需开启
serviceMonitor:
  enabled: false
